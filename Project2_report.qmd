---
title: "Predicting beta-carotene content in plasma"
subtitle: "Project 2"
author: 
 - name: Hoang Long Nguyen
   affiliations:
     - name: Lund University
       department: Department of Geology
       address: Sölvegatan 12, S-223 62 Lund, Sweden
 - name: Dmytro Perepolkin
   affiliations:
     - name: Lund University
       department: Centre for Environmental and Climate Science
       address: Sölvegatan 37, S-223 62 Lund, Sweden
#bibliography: Project1_plasma.bib
format: 
  titlepage-pdf:
    documentclass: scrbook
    classoption: ["oneside", "open=any"]
    number-sections: true
    titlepage: classic-lined 
    titlepage-logo: "img/logo.png"
    titlepage-footer: |
      Group 1
      Lund University\
      Lund, Sweden\
      [https://lu.se](https://lu.se)\
    titlepage-theme:
      elements: ["\\titleblock", "\\authorblock", "\\vfill", "\\logoblock", "\\footerblock"]
      page-align: "center"
      title-style: "doublelinewide"
      title-fontsize: 30
      title-fontstyle: "uppercase"
      title-space-after: "0.1\\textheight"
      subtitle-fontstyle: ["Large", "textit"]
      author-style: "plain"
      author-sep: "\\hskip1em"
      author-fontstyle: "Large"
      author-space-after: "2\\baselineskip"
      affiliation-style: "numbered-list-with-correspondence"
      affiliation-fontstyle: "large"
      affiliation-space-after: "0pt"
      footer-style: "plain"
      footer-fontstyle: ["large", "textsc"]
      footer-space-after: "0pt"
      logo-size: "0.25\\textheight"
      logo-space-after: "1cm"
---

```{r setup, message=FALSE}
#| message: false
#install.packages("corrgram")
library(tidyverse)
library(broom)
library(corrgram) # visualisation of correlations
library(lmtest)  # more linear regression tools
library(hrbrthemes) #ggplot styling
library(GGally) # Pair plot
library(ggplot2) # ggplot 2
library(hrbrthemes) # theme for ggplot
library(kableExtra)
library(leaps)
library(glmnet)
ggplot2::theme_set(hrbrthemes::theme_ipsum_rc())

extrafont::loadfonts(device = "all", quiet = TRUE)

knitr::opts_chunk$set(dev = 'png')
options(device = function(file, width, height) {
  png(tempfile(), width = width, height = height)
})
```

# Introduction

## Data description

The dataset is from `gamlss.data` package [@harrell2002PlasmaRetinolBetaCarotene]. It is a cross-sectional study to investigate the relationship between personal characteristics and dietary factors, and plasma concentrations.

An original data frame has 315 observations of the following variables

| Variable        | Description                                             |
|-----------------|---------------------------------------------------------|
| `age`           | age(years)                                              |
| `sex`           | sex, 1=male, 2=female                                   |
| `smokstat`      | smoking status 1=never, 2=former, 3=current Smoker      |
| `bmi`           | body mass index weight/(height\^2)                      |
| `vituse`        | vitamin use 1=yes, fairly often, 2=yes, not often, 3=no |
| `calories`      | number of calories consumed per day                     |
| `fat`           | grams of fat consumed per day                           |
| `fiber`         | grams of fiber consumed per day                         |
| `alcohol`       | number of alcoholic drinks consumed per week            |
| `cholesterol`   | cholesterol consumed (mg per day)                       |
| `betadiet`      | dietary beta-carotene consumed (mcg per day)            |
| `retdiet`[^1]   | dietary retinol consumed (mcg per day)                  |
| `betaplasma`    | plasma beta-carotene (ng/ml)                            |
| `retplasma`[^2] | plasma retinol (ng/ml)                                  |

[^1]: Not present in the current version of the dataset

[^2]: Not present in the current version of the dataset

We import the data

```{r}
plasma_df <- read_csv("data/plasma.txt", show_col_types = FALSE)
```

> Observational studies have suggested that low dietary intake or low plasma concentrations of retinol, beta-carotene, or other carotenoids might be associated with increased risk of developing certain types of cancer... We designed a cross-sectional study to investigate the relationship between personal characteristics and dietary factors, and plasma concentrations of retinol, beta-carotene and other carotenoids. [@harrell2002PlasmaRetinolBetaCarotene]

# Multivariate regression

 glmnet requires a model-matrix as the model specification.
 A model matrix is a matrix with a column for each predictor (=x-variable) in the model (including the extra columns for polynomials, dummy variables etc), and each row is for a unique observation.
 Sometimes the model-matrix includes a column for the intercept, in glmnet it should (typically) not.

```{r}
#head(plasma_df)
x <- model.matrix(log(betaplasma) ~ ., plasma_df)[, -1]
#head(x)
y <- log(plasma_df$betaplasma)
#head(y)
```

```{r}
# Grid of lambdas
grid <- 10^seq(10, -2, length = 100) #grid 

# Run ridge regression (alpha =0) for each lambda in grid
ridge.mod <- glmnet(x, y, alpha = 0, lambda = grid)
```

The `ridge.mod` contains `r dim(coef(ridge.mod))[1]` rows and `r dim(coef(ridge.mod))[2]` columns corresponding to the number of $\lambda$ values we created earlier.

```{r}
# Prepare for cross validation by splitting the data in training and validation set
set.seed(42)
train <- sample(1:nrow(x), nrow(x) / 2)
test <- (-train)
y.test <- y[test]

```

```{r}
# Fit ridge regression on the training data, for our grid of lambda
ridge.mod <- glmnet(x[train, ], y[train], alpha = 0,
    lambda = grid, thresh = 1e-12)
# Find predictions for our testdata for a specific lambda (here lambda =4)
ridge.pred <- predict(ridge.mod, s = 4, newx = x[test, ])

```
 The MSE for the $\lambda = 4$ is `r mean((ridge.pred - y.test)^2)`. @fig-ridge-plot1 shows the ridge model ceofficients that ,mksjdhfgkdfgjh
 
```{r}
#| label: fig-ridge-plot1
#| fig-width: 10
#| fig-height: 5
#| out-width: 80%
#| fig-cap: A graph of the ridge model coefficients for different lambdas
plot(ridge.mod,xvar="lambda",lwd=1.5)
```
```{r}
## 10-fold CV to evaluate test error for different lamdas 
set.seed(1)
cv.out <- cv.glmnet(x[train, ], y[train], alpha = 0)
plot(cv.out)
# Choose the best:
bestlam <- cv.out$lambda.min
```

The best $\lambda=`r bestlam`$

```{r}
# MSE associated with this lambda
ridge.pred <- predict(ridge.mod, s = bestlam,
    newx = x[test, ])
mean((ridge.pred - y.test)^2)

```


Lasso


# References
